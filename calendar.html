<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyHelper | Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ðŸ”’ HIDDEN BY DEFAULT (ANTI BLINK) */
body {
  display: none;
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  min-height: 100vh;
}

header {
  background: #fff;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container {
  max-width: 900px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #ddd;
  padding: 14px;
  text-align: center;
  cursor: pointer;
}

th {
  background: #667eea;
  color: #fff;
}

td:hover {
  background: #eef;
}

.today {
  background: #ffd54f !important;
  font-weight: bold;
}
</style>
</head>

<body>

<header>
  <strong>ðŸ“… Calendar</strong>
  <button onclick="location.href='home.html'">â¬… Back</button>
</header>

<div class="container">
  <h2 id="monthLabel"></h2>
  <table id="calendar"></table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid = null;

/* ðŸ” AUTH CHECK â€” NO BLINK */
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.replace("index.html");
    return;
  }

  uid = user.uid;
  document.body.style.display = "block"; // SHOW PAGE
  requestNotificationPermission();
  buildCalendar();
});

/* ðŸ”” NOTIFICATION */
function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }
}

/* ðŸ“… CALENDAR */
function buildCalendar() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();

  document.getElementById("monthLabel").innerText =
    now.toLocaleString("default", { month: "long", year: "numeric" });

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  const table = document.getElementById("calendar");
  table.innerHTML = `
    <tr>
      <th>Sun</th><th>Mon</th><th>Tue</th>
      <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
    </tr>
  `;

  let row = "<tr>";
  for (let i = 0; i < firstDay; i++) row += "<td></td>";

  for (let d = 1; d <= lastDate; d++) {
    const dateStr =
      `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

    const cls = d === today ? "today" : "";
    row += `<td class="${cls}" data-date="${dateStr}">${d}</td>`;

    if ((firstDay + d) % 7 === 0) {
      table.innerHTML += row + "</tr>";
      row = "<tr>";
    }
  }
  table.innerHTML += row + "</tr>";

  document.querySelectorAll("td[data-date]").forEach(td => {
    td.addEventListener("click", () => addTask(td.dataset.date));
  });
}

/* âž• ADD TASK */
async function addTask(date) {
  const title = prompt(`Add task for ${date}`);
  if (!title) return;

  await addDoc(collection(db, "users", uid, "calendarTasks"), {
    title,
    date,
    createdAt: serverTimestamp(),
    notified: false
  });

  if (Notification.permission === "granted") {
    new Notification("ðŸ“… StudyHelper", {
      body: `${title} â€¢ ${date}`
    });
  }
}
</script>

</body>
</html>
