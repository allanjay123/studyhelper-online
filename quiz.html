<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyHelper | Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  margin:0;
  padding:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  max-width:700px;
  margin:auto;
}
.choice{
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-bottom:8px;
  cursor:pointer;
}
.choice.selected{background:#c8e6c9}
.timer{color:#f44336;font-weight:bold}
button{
  padding:10px 14px;
  background:#4caf50;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
input{width:100%;padding:8px;margin-bottom:6px}
</style>
</head>

<body>

<div class="card" id="box">
  <button onclick="history.back()">â¬… Back</button>
  <h2 id="title">ðŸ§  Quiz</h2>
  <div class="timer" id="timer">Time: 300</div>
  <div id="qBox"></div>
  <div id="cBox"></div>
  <button onclick="next()">Next</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCk3YyAne_nz0fwChI6557R8RtcmlMAawA",
  authDomain: "studyhelper-app.firebaseapp.com",
  projectId: "studyhelper-app"
});
const db=firebase.firestore();

const id=new URLSearchParams(location.search).get("noteId");
let Q=[],i=0,score=0,selected=null,time=300;

db.collection("notes").doc(id).get().then(doc=>{
  const note=doc.data();
  title.textContent="ðŸ§  "+note.title;
  generate(note.body);
  show();
  startTimer();
});

function generate(text){
  const s=text.split(".").map(x=>x.trim()).filter(x=>x.split(" ").length>6);
  const w=text.toLowerCase().replace(/[^a-z ]/g,"").split(" ").filter(x=>x.length>4);
  const uniq=[...new Set(w)];

  s.forEach(line=>{
    const words=line.split(" ").filter(x=>x.length>4);
    const ans=words[Math.floor(Math.random()*words.length)];
    Q.push({
      type:"mc",
      q:line.replace(ans,"_____"),
      a:ans,
      c:shuffle([ans,random(uniq),random(uniq),random(uniq)])
    });
  });

  Q.push({
    type:"enum",
    q:"Based on the lesson, write THREE key terms:",
    a:shuffle(uniq).slice(0,3)
  });

  Q=shuffle(Q).slice(0,15);
}

function show(){
  selected=null;
  cBox.innerHTML="";
  if(i>=Q.length){
    box.innerHTML=`<h2>Finished</h2><p>Score: ${score}/${Q.length}</p>`;
    return;
  }
  qBox.innerHTML=`<b>${i+1}. ${Q[i].q}</b>`;

  if(Q[i].type==="mc"){
    Q[i].c.forEach(x=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=x;
      d.onclick=()=>{
        document.querySelectorAll(".choice").forEach(e=>e.classList.remove("selected"));
        d.classList.add("selected");
        selected=x;
      };
      cBox.appendChild(d);
    });
  }else{
    for(let k=1;k<=3;k++){
      cBox.innerHTML+=`<input placeholder="Answer ${k}">`;
    }
  }
}

function next(){
  const q=Q[i];
  if(q.type==="mc" && selected===q.a) score++;
  if(q.type==="enum"){
    let hit=0;
    [...cBox.querySelectorAll("input")].forEach(x=>{
      if(q.a.includes(x.value.toLowerCase())) hit++;
    });
    if(hit>=2) score++;
  }
  i++; show();
}

function startTimer(){
  setInterval(()=>{
    time--; timer.textContent="Time: "+time;
    if(time<=0) show();
  },1000);
}

function random(a){return a[Math.floor(Math.random()*a.length)]||"example"}
function shuffle(a){return a.sort(()=>Math.random()-0.5)}
</script>

</body>
</html>
