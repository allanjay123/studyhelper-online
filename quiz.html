<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#764ba2;padding:20px}
.box{background:white;max-width:600px;margin:auto;padding:20px;border-radius:10px}
.choice{border:1px solid #ccc;padding:8px;margin-top:6px;cursor:pointer}
.choice.selected{background:#c8e6c9}
</style>
</head>
<body>

<div class="box" id="box">
  <h2 id="q">Loading...</h2>
  <div id="choices"></div>
  <button onclick="next()">Next</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCk3YyAne_nz0fwChI6557R8RtcmlMAawA",
  authDomain: "studyhelper-app.firebaseapp.com",
  projectId: "studyhelper-app",
  storageBucket: "studyhelper-app.appspot.com",
  messagingSenderId: "390954392930",
  appId: "1:390954392930:web:4c7ebc6a37112e98dce03b"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const id=new URLSearchParams(location.search).get("id");
let quiz=[],i=0,score=0,selected=null;

db.collection("notes").doc(id).get().then(doc=>{
  if(!doc.exists){
    alert("NOTE NOT FOUND");
    return;
  }
  generateQuiz(doc.data().body);
  show();
});

function generateQuiz(text){
  const sentences=text.split(".").filter(s=>s.split(" ").length>6);
  const words=text.toLowerCase().replace(/[^a-z ]/g,"").split(" ").filter(w=>w.length>4);

  sentences.forEach(s=>{
    const ws=s.split(" ").filter(w=>w.length>4);
    const ans=ws[Math.floor(Math.random()*ws.length)];
    quiz.push({
      q:s.replace(ans,"_____"),
      a:ans,
      c:shuffle([ans,random(words),random(words),random(words)])
    });
  });
}

function show(){
  selected=null;
  if(i>=quiz.length){
    box.innerHTML=`<h2>Score ${score}/${quiz.length}</h2>`;
    return;
  }
  q.textContent=quiz[i].q;
  choices.innerHTML="";
  quiz[i].c.forEach(c=>{
    const d=document.createElement("div");
    d.className="choice";
    d.textContent=c;
    d.onclick=()=>{
      document.querySelectorAll(".choice").forEach(x=>x.classList.remove("selected"));
      d.classList.add("selected");
      selected=c;
    };
    choices.appendChild(d);
  });
}

function next(){
  if(selected===quiz[i].a) score++;
  i++;
  show();
}

function random(a){return a[Math.floor(Math.random()*a.length)]||"example"}
function shuffle(a){return a.sort(()=>Math.random()-0.5)}
</script>

</body>
</html>
