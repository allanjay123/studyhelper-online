<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyHelper | Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}
header{
  background:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  max-width:900px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ddd;
  padding:15px;
  text-align:center;
  cursor:pointer;
}
th{
  background:#667eea;
  color:#fff;
}
td:hover{
  background:#f0f0ff;
}
.today{
  background:#ffd54f !important;
}
</style>
</head>

<body>

<header>
  <strong>ðŸ“… Calendar</strong>
  <button onclick="location.href='home.html'">â¬… Back</button>
</header>

<div class="container">
  <h2 id="monthLabel"></h2>
  <table id="calendar"></table>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUID = null;

// ðŸ” AUTH CHECK (ANTI-BLINK FIX)
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    currentUID = user.uid;
    buildCalendar();
    askNotificationPermission();
  }
});

// ðŸ”” NOTIFICATION PERMISSION
function askNotificationPermission(){
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }
}

// ðŸ“… BUILD CALENDAR
function buildCalendar(){
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  document.getElementById("monthLabel").innerText =
    now.toLocaleString("default",{month:"long",year:"numeric"});

  const table = document.getElementById("calendar");
  table.innerHTML = `
    <tr>
      <th>Sun</th><th>Mon</th><th>Tue</th>
      <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
    </tr>
  `;

  let row = "<tr>";
  for(let i=0;i<firstDay;i++) row += "<td></td>";

  for(let d=1; d<=lastDate; d++){
    const fullDate = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const cls = d === today ? "today" : "";

    row += `<td class="${cls}" data-date="${fullDate}">${d}</td>`;
    if((firstDay + d) % 7 === 0){
      table.innerHTML += row + "</tr>";
      row = "<tr>";
    }
  }
  table.innerHTML += row + "</tr>";

  document.querySelectorAll("td[data-date]").forEach(td=>{
    td.addEventListener("click", ()=> addTask(td.dataset.date));
  });
}

// âž• ADD TASK + FIREBASE + NOTIF
async function addTask(date){
  const title = prompt(`Add task for ${date}`);
  if (!title) return;

  await addDoc(collection(db,"users",currentUID,"calendarTasks"),{
    title,
    date,
    notified:false,
    createdAt: serverTimestamp()
  });

  if (Notification.permission === "granted") {
    new Notification("ðŸ“Œ Task Added", {
      body: `${title} on ${date}`
    });
  }
}
</script>

</body>
</html>
