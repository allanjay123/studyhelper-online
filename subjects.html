<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyHelper | Subjects</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}

header{
  background:#fff;
  padding:10px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  max-width:900px;
  margin:20px auto;
  padding:10px;
}

.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

input{
  width:100%;
  padding:8px;
  margin-bottom:8px;
}

button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#4caf50;
  color:#fff;
  cursor:pointer;
}

button.delete{
  background:#f44336;
  margin-left:6px;
  font-size:12px;
}

.subject{
  border-bottom:1px solid #eee;
  padding:10px 0;
}

.lesson{
  display:flex;
  align-items:center;
  gap:8px;
  margin:6px 0;
}
</style>
</head>

<body>

<header>
  <strong>ðŸ“š Subjects</strong>
  <button onclick="location.href='home.html'">â¬… Back</button>
</header>

<div class="container">

  <!-- ADD SUBJECT -->
  <div class="card">
    <h3>Add Subject</h3>
    <input id="subjectName" placeholder="Subject name (e.g. Math)">
    <button id="addSubject">Add Subject</button>
  </div>

  <!-- SUBJECT LIST -->
  <div class="card">
    <h3>Your Subjects</h3>
    <div id="subjectsList"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCk3YyAne_nz0fwChI6557R8RtcmlMAawA",
  authDomain: "studyhelper-app.firebaseapp.com",
  projectId: "studyhelper-app"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid;

/* AUTH */
onAuthStateChanged(auth, user => {
  if (!user) location.href = "index.html";
  uid = user.uid;
  loadSubjects();
});

/* ADD SUBJECT */
addSubject.onclick = async () => {
  if (!subjectName.value) return;

  await addDoc(collection(db, "users", uid, "subjects"), {
    name: subjectName.value
  });

  subjectName.value = "";
};

/* LOAD SUBJECTS + LESSONS */
function loadSubjects(){
  onSnapshot(collection(db,"users",uid,"subjects"), snap => {
    subjectsList.innerHTML = "";

    snap.forEach(s => {
      const sid = s.id;
      const subjectDiv = document.createElement("div");
      subjectDiv.className = "subject";

      subjectDiv.innerHTML = `
        <strong>${s.data().name}</strong>
        <button class="delete">Delete</button>
        <div style="margin-top:8px;">
          <input placeholder="New lesson" id="lesson-${sid}">
          <button>Add Lesson</button>
        </div>
        <div id="lessons-${sid}"></div>
      `;

      /* DELETE SUBJECT */
      subjectDiv.querySelector(".delete").onclick = () =>
        deleteDoc(doc(db,"users",uid,"subjects",sid));

      /* ADD LESSON */
      subjectDiv.querySelector("button:not(.delete)").onclick = async () => {
        const input = document.getElementById(`lesson-${sid}`);
        if (!input.value) return;

        await addDoc(
          collection(db,"users",uid,"subjects",sid,"lessons"),
          { title: input.value, completed: false }
        );
        input.value = "";
      };

      /* LOAD LESSONS */
      onSnapshot(
        collection(db,"users",uid,"subjects",sid,"lessons"),
        ls => {
          const list = subjectDiv.querySelector(`#lessons-${sid}`);
          list.innerHTML = "";

          ls.forEach(l => {
            const row = document.createElement("div");
            row.className = "lesson";
            row.textContent = "â€¢ " + l.data().title;
            list.appendChild(row);
          });
        }
      );

      subjectsList.appendChild(subjectDiv);
    });
  });
}
</script>

</body>
</html>
