<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyHelper | Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
header{
  background:#fff;
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  max-width:1100px;
  margin:20px auto;
  padding:20px;
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:16px;
}
.card{
  background:#fff;
  padding:15px;
  border-radius:10px;
}
input,textarea{
  width:100%;
  padding:8px;
  margin-bottom:8px;
}
button{
  padding:7px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#4caf50;
  color:white;
}
.small{
  background:#f44336;
  font-size:12px;
  margin-left:6px;
}
.progress{
  height:8px;
  background:#ddd;
  border-radius:5px;
  overflow:hidden;
  margin-top:4px;
}
.progress div{
  height:100%;
  background:#4caf50;
}
.lesson{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.lesson.done{
  text-decoration:line-through;
  color:#777;
}
</style>
</head>

<body>

<header>
  <strong>StudyHelper</strong>
  <div>
    <button onclick="location.href='subjects.html'">ðŸ“š Subjects</button>
    <button onclick="location.href='calendar.html'">ðŸ“… Calendar</button>
    <button id="logout">Logout</button>
  </div>
</header>

<div class="container">

  <!-- LEFT -->
  <div>

    <div class="card">
      <h3>Add Note</h3>
      <input id="noteTitle" placeholder="Title">
      <textarea id="noteBody" placeholder="Your note"></textarea>
      <button id="saveNote">Save Note</button>
    </div>

    <div class="card">
      <h3>Your Notes</h3>
      <div id="notes"></div>
    </div>

    <div class="card">
      <h3>Tasks</h3>
      <input id="taskInput" placeholder="New task">
      <button id="addTask">Add Task</button>
      <div id="tasks"></div>
    </div>

    <div class="card">
      <h3>Lessons</h3>
      <div id="lessons"></div>
    </div>

  </div>

  <!-- RIGHT -->
  <div>

    <div class="card">
      <h3>ðŸ“Š Subjects Mastery</h3>
      <div id="subjectsMastery"></div>
    </div>

    <div class="card">
      <h3>âœ… Tasks Progress</h3>
      <div id="tasksProgress"></div>
    </div>

  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  deleteDoc,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCkY...",
  authDomain: "studyhelper-app.firebaseapp.com",
  projectId: "studyhelper-app"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const uid = auth.currentUser.uid; // SAFE (auth-gate)

/* ELEMENTS */
const notesDiv = notes;
const tasksDiv = tasks;
const lessonsDiv = lessons;
const subjectsDiv = subjectsMastery;
const tasksProgress = document.getElementById("tasksProgress");

/* LOGOUT */
logout.onclick = async ()=>{
  await signOut(auth);
  location.replace("index.html");
};

/* ADD NOTE */
saveNote.onclick = async ()=>{
  if(!noteTitle.value || !noteBody.value) return;
  await addDoc(collection(db,"users",uid,"notes"),{
    title:noteTitle.value,
    body:noteBody.value
  });
  noteTitle.value="";
  noteBody.value="";
  loadAll();
};

/* ADD TASK */
addTask.onclick = async ()=>{
  if(!taskInput.value) return;
  await addDoc(collection(db,"users",uid,"tasks"),{
    text:taskInput.value,
    done:false
  });
  taskInput.value="";
  loadAll();
};

/* LOAD EVERYTHING ONCE */
async function loadAll(){
  await Promise.all([
    loadNotes(),
    loadTasks(),
    loadSubjectsAndLessons()
  ]);
}

/* NOTES */
async function loadNotes(){
  notesDiv.innerHTML="";
  const snap = await getDocs(collection(db,"users",uid,"notes"));
  snap.forEach(d=>{
    const n=d.data();
    const div=document.createElement("div");
    div.innerHTML=`<strong>${n.title}</strong><p>${n.body||""}</p>`;
    const del=document.createElement("button");
    del.textContent="Delete";
    del.className="small";
    del.onclick=async()=>{
      await deleteDoc(doc(db,"users",uid,"notes",d.id));
      loadAll();
    };
    div.appendChild(del);
    notesDiv.appendChild(div);
  });
}

/* TASKS */
async function loadTasks(){
  tasksDiv.innerHTML="";
  const snap = await getDocs(collection(db,"users",uid,"tasks"));
  let done=0;
  snap.forEach(d=>{
    const t=d.data();
    if(t.done) done++;
    const row=document.createElement("div");

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked=t.done;
    cb.onchange=async()=>{
      await updateDoc(doc(db,"users",uid,"tasks",d.id),{done:cb.checked});
      loadAll();
    };

    const del=document.createElement("button");
    del.textContent="X";
    del.className="small";
    del.onclick=async()=>{
      await deleteDoc(doc(db,"users",uid,"tasks",d.id));
      loadAll();
    };

    row.append(cb," "+t.text+" ",del);
    tasksDiv.appendChild(row);
  });

  const total=snap.size;
  const pct=total?Math.round(done/total*100):0;
  tasksProgress.innerHTML=`
    ${done}/${total} completed (${pct}%)
    <div class="progress"><div style="width:${pct}%"></div></div>
  `;
}

/* SUBJECTS â†’ LESSONS â†’ AUTO MASTERY */
async function loadSubjectsAndLessons(){
  subjectsDiv.innerHTML="";
  lessonsDiv.innerHTML="";

  const subjectsSnap = await getDocs(collection(db,"users",uid,"subjects"));

  for(const subj of subjectsSnap.docs){
    const sid=subj.id;
    const s=subj.data();

    const lessonsSnap = await getDocs(
      collection(db,"users",uid,"subjects",sid,"lessons")
    );

    let done=0;
    lessonsSnap.forEach(l=>{
      if(l.data().completed) done++;
      const row=document.createElement("div");
      row.className="lesson"+(l.data().completed?" done":"");

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked=l.data().completed;
      cb.onchange=async()=>{
        await updateDoc(
          doc(db,"users",uid,"subjects",sid,"lessons",l.id),
          {completed:cb.checked}
        );
        loadAll();
      };

      row.append(cb,`${s.name}: ${l.data().title}`);
      lessonsDiv.appendChild(row);
    });

    const total=lessonsSnap.size;
    const pct=total?Math.round(done/total*100):0;

    const box=document.createElement("div");
    box.innerHTML=`
      <strong>${s.name}</strong> â€“ ${pct}%
      <div class="progress"><div style="width:${pct}%"></div></div>
    `;
    subjectsDiv.appendChild(box);
  }
}

/* INIT */
loadAll();
</script>

</body>
</html>
