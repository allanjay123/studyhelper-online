<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  padding:20px;
}
.card{
  background:white;
  max-width:700px;
  margin:auto;
  padding:20px;
  border-radius:12px;
}
.choice{
  border:1px solid #ccc;
  padding:10px;
  border-radius:6px;
  margin-bottom:6px;
  cursor:pointer;
}
.choice.selected{background:#c8e6c9}
.timer{color:red;font-weight:bold}
button{
  background:#4caf50;
  color:white;
  border:none;
  padding:10px;
  border-radius:6px;
  cursor:pointer;
}
input{width:100%;padding:8px;margin-bottom:6px}
</style>
</head>

<body>

<div class="card" id="box">
  <button onclick="history.back()">â¬… Back</button>
  <h2 id="title">ðŸ§  Quiz</h2>
  <div class="timer" id="timer">Time: 300</div>
  <div id="q"></div>
  <div id="c"></div>
  <button onclick="next()">Next</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCk3YyAne_nz0fwChI6557R8RtcmlMAawA",
  projectId: "studyhelper-app"
});
const db=firebase.firestore();

const id=new URLSearchParams(location.search).get("noteId");
let Q=[],i=0,score=0,sel=null,time=300;

db.collection("notes").doc(id).get().then(d=>{
  if(!d.exists){alert("Note not found");return;}
  title.textContent="ðŸ§  "+d.data().title;
  buildQuiz(d.data().body);
  show();
  setInterval(()=>{
    time--;timer.textContent="Time: "+time;
    if(time<=0) finish();
  },1000);
});

function buildQuiz(text){
  const s=text.split(".").map(x=>x.trim()).filter(x=>x.split(" ").length>6);
  const w=text.toLowerCase().replace(/[^a-z ]/g,"").split(" ").filter(x=>x.length>4);
  const k=[...new Set(w)];

  s.forEach(line=>{
    const words=line.split(" ").filter(x=>x.length>4);
    const a=words[Math.floor(Math.random()*words.length)];
    Q.push({
      t:"mc",
      q:line.replace(a,"_____"),
      a,
      c:shuffle([a,rand(k),rand(k),rand(k)])
    });
  });

  Q.push({
    t:"enum",
    q:"Write THREE important ideas from the lesson:",
    a:shuffle(k).slice(0,3)
  });

  Q=shuffle(Q).slice(0,15);
}

function show(){
  sel=null;c.innerHTML="";
  if(i>=Q.length){finish();return;}
  q.innerHTML=`<b>${i+1}. ${Q[i].q}</b>`;

  if(Q[i].t==="mc"){
    Q[i].c.forEach(x=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=x;
      d.onclick=()=>{
        document.querySelectorAll(".choice").forEach(e=>e.classList.remove("selected"));
        d.classList.add("selected");
        sel=x;
      };
      c.appendChild(d);
    });
  }else{
    for(let n=1;n<=3;n++) c.innerHTML+=`<input placeholder="Answer ${n}">`;
  }
}

function next(){
  const qn=Q[i];
  if(qn.t==="mc" && sel===qn.a) score++;
  if(qn.t==="enum"){
    let hit=0;
    [...c.querySelectorAll("input")].forEach(x=>{
      if(qn.a.includes(x.value.toLowerCase())) hit++;
    });
    if(hit>=2) score++;
  }
  i++;show();
}

function finish(){
  box.innerHTML=`<h2>Finished</h2><p>Score: ${score}/${Q.length}</p>`;
}

function rand(a){return a[Math.floor(Math.random()*a.length)]||"example"}
function shuffle(a){return a.sort(()=>Math.random()-0.5)}
</script>

</body>
</html>
