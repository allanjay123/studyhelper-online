<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Arial;
  background:#764ba2;
  padding:20px;
}
.box{
  background:white;
  max-width:600px;
  margin:auto;
  padding:20px;
  border-radius:10px;
}
.choice{
  border:1px solid #ccc;
  padding:8px;
  margin-bottom:6px;
  cursor:pointer;
}
.choice.selected{background:#c8e6c9}
</style>
</head>

<body>

<div class="box" id="box">
  <button onclick="history.back()">â¬… Back</button>
  <h2 id="q"></h2>
  <div id="choices"></div>
  <button onclick="next()">Next</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCk3YyAne_nz0fwChI6557R8RtcmlMAawA",
  projectId: "studyhelper-app"
});

const db=firebase.firestore();
const id=new URLSearchParams(location.search).get("id");

let Q=[],i=0,score=0,selected=null;

db.collection("notes").doc(id).get().then(doc=>{
  if(!doc.exists){
    alert("Note not found");
    return;
  }
  build(doc.data().body);
  show();
});

function build(text){
  const s=text.split(".").filter(x=>x.split(" ").length>5);
  const w=text.toLowerCase().replace(/[^a-z ]/g,"").split(" ").filter(x=>x.length>4);

  s.forEach(line=>{
    const ws=line.split(" ").filter(x=>x.length>4);
    const ans=ws[Math.floor(Math.random()*ws.length)];
    Q.push({
      q: line.replace(ans,"_____"),
      a: ans,
      c: shuffle([ans,rand(w),rand(w),rand(w)])
    });
  });
}

function show(){
  selected=null;
  if(i>=Q.length){
    box.innerHTML=`<h2>Score: ${score}/${Q.length}</h2>`;
    return;
  }
  q.textContent=Q[i].q;
  choices.innerHTML="";
  Q[i].c.forEach(x=>{
    const d=document.createElement("div");
    d.className="choice";
    d.textContent=x;
    d.onclick=()=>{
      document.querySelectorAll(".choice").forEach(e=>e.classList.remove("selected"));
      d.classList.add("selected");
      selected=x;
    };
    choices.appendChild(d);
  });
}

function next(){
  if(selected===Q[i].a) score++;
  i++;
  show();
}

function rand(a){return a[Math.floor(Math.random()*a.length)]||"example"}
function shuffle(a){return a.sort(()=>Math.random()-0.5)}
</script>

</body>
</html>
