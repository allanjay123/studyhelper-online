<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyHelper | Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
}
header{
  background:#fff;
  padding:10px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  max-width:1000px;
  margin:20px auto;
  padding:20px;
}
.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}
.card{
  background:#fff;
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
}
input, textarea{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#667eea;
  color:white;
  cursor:pointer;
}
.delete{
  background:red;
  float:right;
}
.progress{
  background:#ddd;
  height:10px;
  border-radius:10px;
  overflow:hidden;
}
.progress div{
  height:100%;
}
li{
  background:#f3f3f3;
  padding:10px;
  border-radius:6px;
  margin-top:6px;
}
@media(max-width:800px){
  .grid{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<header>
  <strong>StudyHelper</strong>
  <div>
    <button onclick="location.href='calendar.html'">ðŸ“… Calendar</button>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<div class="container">

  <!-- WELCOME -->
  <div class="card">
    <h3>Welcome ðŸŽ‰</h3>
    <p id="userEmail"></p>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div>

      <!-- NOTES -->
      <div class="card">
        <h3>Add Note</h3>
        <input id="title" placeholder="Title">
        <textarea id="content" placeholder="Your note"></textarea>
        <button id="saveBtn">Save Note</button>
      </div>

      <div class="card">
        <h3>Your Notes</h3>
        <div id="notes"></div>
      </div>

      <!-- TASKS -->
      <div class="card">
        <h3>Tasks</h3>
        <input id="taskInput" placeholder="New task">
        <button id="addTaskBtn">Add Task</button>
        <ul id="taskList"></ul>
      </div>

    </div>

    <!-- RIGHT -->
    <div>

      <!-- SUBJECTS -->
      <div class="card">
        <h3>ðŸ“Š Subjects Mastery</h3>
        <div id="subjectsPreview">Loading...</div>
        <button style="margin-top:10px" onclick="location.href='subjects.html'">
          View All Subjects
        </button>
      </div>

    </div>

  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  deleteDoc,
  doc,
  updateDoc,
  serverTimestamp,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCk3YyAne_nz0fwChI6557R8RtcmlMAawA",
  authDomain: "studyhelper-app.firebaseapp.com",
  projectId: "studyhelper-app"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid=null;

const userEmail=document.getElementById("userEmail");
const notesDiv=document.getElementById("notes");
const taskList=document.getElementById("taskList");
const subjectsPreview=document.getElementById("subjectsPreview");

// AUTH
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
  }else{
    uid=user.uid;
    userEmail.textContent="Logged in as: "+user.email;
    loadNotes();
    loadTasks();
    loadSubjects();
  }
});

// NOTES
function loadNotes(){
  const ref=query(
    collection(db,"users",uid,"notes"),
    orderBy("createdAt","desc")
  );
  onSnapshot(ref,snap=>{
    notesDiv.innerHTML="";
    snap.forEach(d=>{
      const n=d.data();
      notesDiv.innerHTML+=`
        <div class="card">
          <strong>${n.title}</strong>
          <button class="delete" onclick="deleteNote('${d.id}')">Delete</button>
          <p>${n.content}</p>
        </div>
      `;
    });
  });
}
window.deleteNote=id=>{
  deleteDoc(doc(db,"users",uid,"notes",id));
};
saveBtn.onclick=async()=>{
  if(!title.value||!content.value) return alert("Fill all fields");
  await addDoc(collection(db,"users",uid,"notes"),{
    title:title.value,
    content:content.value,
    createdAt:serverTimestamp()
  });
  title.value="";content.value="";
};

// TASKS
function loadTasks(){
  const ref=collection(db,"users",uid,"tasks");
  onSnapshot(ref,snap=>{
    taskList.innerHTML="";
    snap.forEach(d=>{
      const t=d.data();
      const li=document.createElement("li");
      li.innerHTML=`
        <input type="checkbox" ${t.done?"checked":""}>
        <span style="text-decoration:${t.done?"line-through":"none"}">${t.text}</span>
        <button class="delete">Delete</button>
      `;
      li.querySelector("input").onchange=e=>{
        updateDoc(doc(db,"users",uid,"tasks",d.id),{done:e.target.checked});
      };
      li.querySelector("button").onclick=()=>{
        deleteDoc(doc(db,"users",uid,"tasks",d.id));
      };
      taskList.appendChild(li);
    });
  });
}
addTaskBtn.onclick=async()=>{
  if(!taskInput.value) return;
  await addDoc(collection(db,"users",uid,"tasks"),{
    text:taskInput.value,
    done:false,
    createdAt:serverTimestamp()
  });
  taskInput.value="";
};

// SUBJECTS
function loadSubjects(){
  const ref=collection(db,"users",uid,"subjects");
  onSnapshot(ref,snap=>{
    subjectsPreview.innerHTML="";
    if(snap.empty){
      subjectsPreview.innerHTML="<p>No subjects yet</p>";
      return;
    }
    snap.forEach(d=>{
      const s=d.data();
      const m=s.mastery ?? 0;
      const color=m<50?"#f44336":m<80?"#ffc107":"#4caf50";
      subjectsPreview.innerHTML+=`
        <div style="margin-bottom:12px">
          <strong>${s.name}</strong> â€“ ${m}%
          <div class="progress">
            <div style="width:${m}%;background:${color}"></div>
          </div>
        </div>
      `;
    });
  });
}

// LOGOUT
logoutBtn.onclick=async()=>{
  await signOut(auth);
  location.href="index.html";
};
</script>

</body>
</html>
